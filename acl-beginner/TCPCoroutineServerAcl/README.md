# Aclμ„ ν™μ©ν• Coroutine TCP Echo Server μμ 

## λ©μ°¨
1. [Acl - Coroutine](#acl---coroutine)
2. [Coroutine κ°λ…](#coroutine-κ°λ…)
3. [TCP Echo Server μμ ](#tcp-echo-server-μμ )
    1. [`run_tcp_coroutine_server` ν•¨μμ μ •μ](#1-run_tcp_coroutine_server-ν•¨μμ-μ •μ)
    2. [μ½”λ£¨ν‹΄μ„ μ‚¬μ©ν• ν΄λΌμ΄μ–ΈνΈ μ—°κ²° μ²λ¦¬](#2-μ½”λ£¨ν‹΄μ„-μ‚¬μ©ν•-ν΄λΌμ΄μ–ΈνΈ-μ—°κ²°-μ²λ¦¬)
        1. [μµμ΄ μ½”λ£¨ν‹΄ μƒμ„± (μ„λ²„ μ—­ν• )](#21-μµμ΄-μ½”λ£¨ν‹΄-μƒμ„±-μ„λ²„-μ—­ν• )
        2. [ν΄λΌμ΄μ–ΈνΈλ§λ‹¤μ μ½”λ£¨ν‹΄ μƒμ„±](#22-ν΄λΌμ΄μ–ΈνΈλ§λ‹¤μ-μ½”λ£¨ν‹΄-μƒμ„±)
        3. [ν΄λΌμ΄μ–ΈνΈ λ°μ΄ν„° μ²λ¦¬](#23-ν΄λΌμ΄μ–ΈνΈ-λ°μ΄ν„°-μ²λ¦¬)
    3. [μ½”λ£¨ν‹΄ μ¤μΌ€μ¤„λ¬ μ‹μ‘](#3-μ½”λ£¨ν‹΄-μ¤μΌ€μ¤„λ¬-μ‹μ‘)
    4. [μ½”λ£¨ν‹΄ κ°λ… κ΄€λ ¨ μ„¤λ…](#4-μ½”λ£¨ν‹΄-κ°λ…-κ΄€λ ¨-μ„¤λ…)
    5. [μ½”λ£¨ν‹΄ λ™κΈ°ν™” κ΄€λ ¨ fiber_mutex μ‚¬μ©](#5-μ½”λ£¨ν‹΄-λ™κΈ°ν™”-κ΄€λ ¨-fiber_mutex-μ‚¬μ©)

---

## Acl - Coroutine
- [π–±οΈfiber lib κ³µμ‹λ¬Έμ„ μ„¤λ…](https://github.com/acl-dev/acl/blob/master/lib_fiber/README_en.md)
- **μ½”λ£¨ν‹΄**μ€ λΉ„λ™κΈ° ν”„λ΅κ·Έλλ°μ„ κ°„νΈν•κ² λ§λ“¤μ–΄μ£Όλ” λ„κµ¬μ…λ‹λ‹¤. <br>
μΌλ°μ μΈ μ¤λ λ“μ™€λ” λ‹¬λ¦¬, ν•λ‚μ μ¤λ λ“ λ‚΄μ—μ„ μ—¬λ¬ μ½”λ£¨ν‹΄μ„ μƒμ„±ν•κ³  μ‹¤ν–‰ν•  μ μμΌλ©°, <br>
μ΄λ“¤ μ½”λ£¨ν‹΄μ€ μ„λ΅ λ…λ¦½μ μΌλ΅ μ‹¤ν–‰λ©λ‹λ‹¤.<br>
μ½”λ£¨ν‹΄μ„ μ‚¬μ©ν•λ©΄ ν”„λ΅κ·Έλ¨μ νλ¦„μ„ μ¤‘λ‹¨ν•μ§€ μ•κ³  λΉ„λ™κΈ° μ‘μ—…μ„ μν–‰ν•  μ μμµλ‹λ‹¤.

<br>

## Coroutine κ°λ…

`β€Coβ€™routine(Co- + routine)`μΌλ΅ μΌμΆ…μ **κ°€λ²Όμ΄ μ¤λ λ“(Light-weight thread)**λ΅ λ™μ‹μ„± μ‘μ—…μ„ κ°„νΈν•κ² ν•  μ μκ² ν•΄μ£Όλ” μ—­ν• μ„ ν•©λ‹λ‹¤. <br>
μ¦‰, μ½”λ£¨ν‹΄μ€ μ‹¤ν–‰μ μ§€μ—°κ³Ό μ¬κ°λ¥Ό ν—μ©ν•μ—¬, **λΉ„μ„ μ μ μΈ λ©€ν‹°νƒμ¤ν‚Ή**μ„ μ„ν• μ„λΈ λ£¨ν‹΄μ„ μΌλ°ν™”ν• μ»΄ν“¨ν„° ν”„λ΅κ·Έλ¨μ κµ¬μ„±μ”μ†μ…λ‹λ‹¤. <br> <br>

* λΉ„μ„ μ ν• : λ‹¤λ¥Έ νƒμ¤ν¬κ°€ λλ‚μ§€ μ•μΌλ©΄ λ‹¤λ¥Έ ν”„λ΅μ„Έμ¤λ” CPUλ¥Ό μ‚¬μ©ν•  μ μ—†μ
* λ”°λΌμ„ μ½”λ£¨ν‹΄μ€ λ™μ‹μ„±μ€ μ κ³µν•μ§€λ§, λ³‘λ ¬μ„±μ€ μ κ³µν•μ§€ μ•μµλ‹λ‹¤.
  * λ™μ‹μ„±(λ³‘ν–‰μ„±) = λ…Όλ¦¬μ μΌλ΅ μ‘μ—…μ΄ λ³‘λ ¬λ΅ μ‹¤ν–‰λλ” κ²ƒμ²λΌ λ³΄μ΄λ” κ²ƒ
  * λ³‘λ ¬μ„± = λ¬Όλ¦¬μ μΌλ΅ μ‘μ—…μ΄ λ³‘λ ¬λ΅ μ‹¤ν–‰λλ” κ²ƒ

<br>


μ„ μ ν•μΌλ΅ λΉ„λ™κΈ° μ²λ¦¬ μ‹ μ•„λμ™€ κ°™μ€ λ¬Έμ κ°€ λ°μƒ
- μ½”λ“μ λ³µμ΅μ„± : λ…λ¦½μ μΈ μ¤λ λ“μ—μ„ κ° λ£¨ν‹΄μ΄ λ™μ‘ν•λ―€λ΅ λ™μ‹μ„± μ μ–΄λ¥Ό μ„ν• λ³µμ΅ν• μ½”λ“κ°€ ν•„μ”ν•κ³  μ½”λ“ νλ¦„ νμ•…μ΄ μ–΄λ µλ‹¤.
- Context switching λΉ„μ© : μ¤λ λ“ μ‚¬μ©μ‹ Context switching λ¦¬μ†μ¤ λΉ„μ©μΌλ΅ μ„±λ¥ μ €ν•κ°€ λ°μƒν•  μ μλ‹¤.

<br>

μ΄λ° λ¬Έμ  ν•΄κ²°μ„ μ„ν•΄ λΉ„μ„ μ μ  λ©€ν‹° νƒμ¤ν‚Ήμ„ μ‚¬μ©ν• μ–Έμ–΄μ  μ§€μ› λ°©λ²•μ΄ **μ½”λ£¨ν‹΄**μ…λ‹λ‹¤.

<br>


μ½”λ£¨ν‹΄μ μ¥μ :
  - **μ‰½κ³  κ°€λ…μ„± λ†’μ€ λΉ„λ™κΈ° μ²λ¦¬**
    + μ½”λ£¨ν‹΄μ„ μ‚¬μ©ν•λ©΄ μμΈ΅ κ°€λ¥ν• ν”„λ΅κ·Έλλ°μ„ ν•  μ μκΈ° λ•λ¬Έμ—, λΉ„κµμ  μ½”λ“ νλ¦„ νμ•…μ΄ μ‰¬μ–΄ λΉ„λ™κΈ° μ²λ¦¬μ„μ—λ„ κ°λ°μκ°€ κ°€λ…μ„± λ†’κ² μ—¬λ¬ μ‘μ—…μ„ μ²λ¦¬ν•  μ μμµλ‹λ‹¤.
  - **λ™μ‹μ„± κµ¬ν„ λ° κ²½λ‰ μ¤λ λ“**
    + λ™μ‹μ„± ν”„λ΅κ·Έλλ°(2κ° μ΄μƒμ ν”„λ΅μ„Έμ¤κ°€ λ™μ‹μ— κ³„μ‚°μ„ μ§„ν–‰ν•λ” μƒνƒ)
    + κ²½λ‰ μ¤λ λ“: μ¤λ λ“λ³΄λ‹¤ λ” μ μ€ μμ›μ„ μ‚¬μ©ν•μ—¬ ν¨μ¨μ μΈ λΉ„λ™κΈ° μ‘μ—…μ„ μν–‰ν•  μ μμµλ‹λ‹¤.


[π“„λ” μμ„Έν• Coroutine κ°λ… π–±οΈclick](../Document/Coroutine.md#μ½”λ£¨ν‹΄coroutineμ΄λ€)

--------------------

## TCP Echo Server μμ 
: ACL λΌμ΄λΈλ¬λ¦¬μ μ½”λ£¨ν‹΄ κΈ°λ¥μ„ μ‚¬μ©ν•μ—¬ TCP μ„λ²„λ¥Ό κµ¬ν„ν• κ²ƒμ…λ‹λ‹¤. 

### 1. `run_tcp_coroutine_server` ν•¨μμ μ •μ

```cpp
void run_tcp_coroutine_server() {
    const char* addr = "127.0.0.1:8088";
    acl::server_socket server;
    if (!server.open(addr)) {
        std::cerr << "Failed to open server socket on " << addr << std::endl;
        return;
    }

    std::cout << "Coroutine TCP Server is running on " << addr << std::endl;
```

- **μ„λ²„ μ†μΌ“ μƒμ„±**: `acl::server_socket server;` μ„λ²„ μ†μΌ“ κ°μ²΄λ¥Ό μƒμ„± (μ΄ μ†μΌ“μ€ ν΄λΌμ΄μ–ΈνΈμ μ—°κ²°μ„ κΈ°λ‹¤λ¦Ό)
- **μ†μΌ“ μ—΄κΈ°**: `server.open(addr)`λ¥Ό ν†µν•΄ μ§€μ •λ μ£Όμ†(`127.0.0.1:8088`)μ—μ„ μ„λ²„ μ†μΌ“μ„ μ—΄μ–΄ ν΄λΌμ΄μ–ΈνΈ μ—°κ²°μ„ λ°›μ„ μ¤€λΉ„ μ‹μ‘


<br>



### 2. μ½”λ£¨ν‹΄μ„ μ‚¬μ©ν• ν΄λΌμ΄μ–ΈνΈ μ—°κ²° μ²λ¦¬

```cpp
    go[&]{
        while (true) {
            acl::socket_stream* conn = server.accept();
            if (conn) {
                go[=] {
                    char buf[256];
                    while (true) {
                        int ret = conn->read(buf, sizeof(buf), false);
                        if (ret <= 0) {  // λ°μ΄ν„° μ½κΈ° μ‹¤ν¨ λλ” μ—°κ²° μΆ…λ£ μ‹
                            std::cerr << "Failed to read data from client or connection closed." << std::endl;
                            break;
                        }

                        buf[ret] = '\0';  // λ¬Έμμ—΄λ΅ μ²λ¦¬ν•κΈ° μ„ν•΄ null-terminator μ¶”κ°€
                        std::cout << "Received from client: " << buf << std::endl;

                        if (conn->write(buf, ret) != ret) {
                            std::cerr << "Failed to send data to client." << std::endl;
                            break;
                        }
                    }
                    delete conn;  // μ—°κ²° μΆ…λ£ μ‹ μ†μΌ“ μ¤νΈλ¦Ό μ‚­μ 
                };
            }
        }
    };
```

#### 2.1 **μµμ΄ μ½”λ£¨ν‹΄ μƒμ„± (μ„λ²„ μ—­ν• )**

- **μ½”λ£¨ν‹΄ μ‹μ‘**: `go[&]{}`λ” μ½”λ£¨ν‹΄μ„ μ‹μ‘ν•λ” κµ¬λ¬Έ
  + μ½”λ£¨ν‹΄μ€ λΉ„λ™κΈ°μ  μ‘μ—…μ„ μ‰½κ² κµ¬ν„ν•  μ μκ² ν•΄μ£Όλ” κ²½λ‰ μ¤λ λ“μ…λ‹λ‹¤.
  + μ—¬κΈ°μ„ `&`λ” μΊ΅μ² λ¦¬μ¤νΈλ΅, μ½”λ£¨ν‹΄ λ‚΄λ¶€μ—μ„ μ™Έλ¶€μ `server` κ°μ²΄λ¥Ό μ‚¬μ© κ°€λ¥ν•λ„λ΅ ν•¨

- **ν΄λΌμ΄μ–ΈνΈ μ—°κ²° μλ½**: `server.accept()`λ” ν΄λΌμ΄μ–ΈνΈμ μ—°κ²°μ„ κΈ°λ‹¤λ¦¬λ©°, μ—°κ²°μ΄ μλ½λλ©΄ `acl::socket_stream* conn` κ°μ²΄λ¥Ό λ°ν™
  + μ΄ κ°μ²΄λ¥Ό μ‚¬μ©ν•΄ ν΄λΌμ΄μ–ΈνΈμ™€ λ°μ΄ν„°λ¥Ό μ£Όκ³ λ°›μ

#### 2.2 **ν΄λΌμ΄μ–ΈνΈλ§λ‹¤μ μ½”λ£¨ν‹΄ μƒμ„±**

- **μƒλ΅μ΄ ν΄λΌμ΄μ–ΈνΈ μ½”λ£¨ν‹΄**: `go[=]{}`λ¥Ό μ‚¬μ©ν•μ—¬ ν΄λΌμ΄μ–ΈνΈκ°€ μ—°κ²°λ  λ•λ§λ‹¤ μƒλ΅μ΄ μ½”λ£¨ν‹΄ μƒμ„±
  + μ΄ μ½”λ£¨ν‹΄μ€ ν΄λΌμ΄μ–ΈνΈμ μ”μ²­μ„ μ²λ¦¬ν•κ³  μ‘λ‹µμ„ λ³΄λ‚΄λ” μ—­ν• 
  + `=`λ” μΊ΅μ² λ¦¬μ¤νΈλ΅, μ™Έλ¶€ λ³€μ(μ—¬κΈ°μ„λ” `conn`)μ„ λ³µμ‚¬ν•μ—¬ μ½”λ£¨ν‹΄ λ‚΄μ—μ„ μ‚¬μ©ν•  μ μλ„λ΅ ν•¨

#### 2.3 **ν΄λΌμ΄μ–ΈνΈ λ°μ΄ν„° μ²λ¦¬**

- **λ°μ΄ν„° μ½κΈ° λ° μ—μ½”**: `conn->read(buf, sizeof(buf), false)`λ¥Ό ν†µν•΄ ν΄λΌμ΄μ–ΈνΈλ΅λ¶€ν„° λ°μ΄ν„° μ½μ
  + μ½μ€ λ°μ΄ν„°λ” `buf`μ— μ €μ¥λκ³ , μ΄λ¥Ό λ‹¤μ‹ ν΄λΌμ΄μ–ΈνΈλ΅ μ¬μ „μ†΅
  
  + **λ°μ΄ν„° μ½κΈ° μ¤λ¥ μ²λ¦¬**: `ret <= 0` μ΅°κ±΄μ€ λ°μ΄ν„° μ½κΈ° μ‹¤ν¨ λλ” ν΄λΌμ΄μ–ΈνΈκ°€ μ—°κ²°μ„ λμ€ κ²½μ°λ¥Ό μλ―Έ
    * μ΄λ• μ½”λ£¨ν‹΄μ€ `break`λ¥Ό ν†µν•΄ λ£¨ν”„λ¥Ό νƒμ¶ ν›„, μ—°κ²° μΆ…λ£

- **λ¬Έμμ—΄ μ²λ¦¬**: λ°μ΄ν„°λ¥Ό λ¬Έμμ—΄λ΅ μ²λ¦¬ν•κΈ° μ„ν•΄ `buf[ret] = '\0';`μ„ μ‚¬μ©ν•΄ null-terminator μ¶”κ°€

- **μ—μ½” μ‹¤ν¨ μ²λ¦¬**: λ§μ•½ `conn->write`μ—μ„ μ‹¤ν¨ν•λ©΄ μ¤λ¥ λ©”μ‹μ§€λ¥Ό μ¶λ ¥ν•κ³  μ—°κ²° μΆ…λ£

- **μμ› ν•΄μ **: λ§μ§€λ§‰μΌλ΅ `delete conn;`μ„ ν†µν•΄ μ—°κ²°λ ν΄λΌμ΄μ–ΈνΈ μ†μΌ“ κ°μ²΄λ¥Ό μ‚­μ ν•μ—¬ λ©”λ¨λ¦¬ ν•΄μ 


<br>



### 3. μ½”λ£¨ν‹΄ μ¤μΌ€μ¤„λ¬ μ‹μ‘

```cpp
    acl::fiber::schedule();  // μ½”λ£¨ν‹΄ μ¤μΌ€μ¤„λ¬ μ‹μ‘
```

- **μ½”λ£¨ν‹΄ μ¤μΌ€μ¤„λ¬ μ‹¤ν–‰**: `acl::fiber::schedule()`μ„ νΈμ¶ν•μ—¬ μ½”λ£¨ν‹΄ μ¤μΌ€μ¤„λ§μ„ μ‹μ‘ν•©λ‹λ‹¤. μ΄ ν•¨μλ” μ½”λ£¨ν‹΄μ΄ μΌμ •ν•κ² μ‹¤ν–‰λλ„λ΅ κ΄€λ¦¬ν•©λ‹λ‹¤.


<br>



### 4. μ½”λ£¨ν‹΄ κ°λ… κ΄€λ ¨ μ„¤λ…

- **μ½”λ£¨ν‹΄**μ€ λΉ„λ™κΈ° ν”„λ΅κ·Έλλ°μ„ κ°„νΈν•κ² λ§λ“¤μ–΄μ£Όλ” λ„κµ¬μ…λ‹λ‹¤.
  μΌλ°μ μΈ μ¤λ λ“μ™€λ” λ‹¬λ¦¬, ν•λ‚μ μ¤λ λ“ λ‚΄μ—μ„ μ—¬λ¬ μ½”λ£¨ν‹΄μ„ μƒμ„±ν•κ³  μ‹¤ν–‰ν•  μ μμΌλ©°, μ΄λ“¤ μ½”λ£¨ν‹΄μ€ μ„λ΅ λ…λ¦½μ μΌλ΅ μ‹¤ν–‰λ©λ‹λ‹¤.
  μ½”λ£¨ν‹΄μ„ μ‚¬μ©ν•λ©΄ ν”„λ΅κ·Έλ¨μ νλ¦„μ„ μ¤‘λ‹¨ν•μ§€ μ•κ³  λΉ„λ™κΈ° μ‘μ—…μ„ μν–‰ν•  μ μμµλ‹λ‹¤.

- **μ½”λ£¨ν‹΄μ μ¥μ **:
  - **λΉ„λ™κΈ° μ²λ¦¬**: λΉ„λ™κΈ°μ μΌλ΅ μ—¬λ¬ μ‘μ—…μ„ μ²λ¦¬ν•  μ μμ–΄ CPU μμ›μ„ ν¨μ¨μ μΌλ΅ μ‚¬μ©ν•  μ μμµλ‹λ‹¤.
  - **μ‰¬μ΄ λ™μ‹μ„± κµ¬ν„**: λ³µμ΅ν• μ¤λ λ“ κ΄€λ¦¬ μ—†μ΄ κ°„λ‹¨ν• μ½”λ“λ΅ λ™μ‹μ„±μ„ κµ¬ν„ν•  μ μμµλ‹λ‹¤.
  - **κ²½λ‰ μ¤λ λ“**: μ¤λ λ“λ³΄λ‹¤ λ” μ μ€ μμ›μ„ μ‚¬μ©ν•μ—¬ ν¨μ¨μ μΈ λΉ„λ™κΈ° μ‘μ—…μ„ μν–‰ν•  μ μμµλ‹λ‹¤.

μ΄ μ½”λ“μ—μ„ κ° ν΄λΌμ΄μ–ΈνΈλ” λ³„λ„μ μ½”λ£¨ν‹΄μ—μ„ μ²λ¦¬λλ―€λ΅, μ—¬λ¬ ν΄λΌμ΄μ–ΈνΈκ°€ λ™μ‹μ— μ—°κ²°λμ–΄λ„ ν¨μ¨μ μΌλ΅ λ™μ‘ν•  μ μμµλ‹λ‹¤.

<br>


### 5. μ½”λ£¨ν‹΄ λ™κΈ°ν™” κ΄€λ ¨ fiber_mutex μ‚¬μ©

μ½”λ£¨ν‹΄ κΈ°λ°μ TCP μ„λ²„μ—μ„λ” μ—¬λ¬ μ½”λ£¨ν‹΄μ΄ λ™μ‹μ— μμ›μ— μ ‘κ·Όν•  μ μμΌλ―€λ΅, λ™κΈ°ν™”κ°€ ν•„μ”ν•  μ μμµλ‹λ‹¤. <br>
μ΄λ• ACLμ—μ„ μ κ³µν•λ” `fiber_mutex`λ¥Ό ν™μ©ν•  μ μμµλ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ μμ›μ„ μ•μ „ν•κ² λ³΄νΈν•κ³ , λ°λ“λ½μ΄λ‚ κ²½ν•© μƒνƒλ¥Ό λ°©μ§€ν•  μ μμµλ‹λ‹¤.

[π“„μ½”λ£¨ν‹΄ λ™κΈ°ν™” κ΄€λ ¨ λ¬Έμ„ λ³΄κΈ°](../Document/Coroutine-fiber_mutex.md)



<br>


